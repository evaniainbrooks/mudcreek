- set_meta_tags title: "My Cart"

%h1.fw-bold.mb-4 My Cart

- if @cart_items.empty?
  = render EmptyStateComponent.new(icon: "cart-x",
      message: "Your cart is empty.",
      link_text: "Browse Listings",
      link_url: listings_path)
- else
  .row.g-4.align-items-start
    .col-12.col-lg-5
      .card.shadow-sm.border-0.mb-3
        .card-body
          %p.fw-semibold.mb-2
            %i.bi.bi-ticket-perforated.me-1
            Discount Code
          - if @discount_code
            .d-flex.align-items-center.gap-2
              %span.badge.text-bg-success.py-2.px-3
                = @discount_code.key
                - if @discount_code.percentage?
                  = "(#{@discount_code.amount_cents / 100}% off)"
              = button_to cart_discount_path, method: :delete, class: "btn btn-sm btn-outline-danger",
                  form: { data: { turbo_confirm: "Remove discount code?" } } do
                %i.bi.bi-x-lg
          - else
            = form_with url: cart_discount_path, method: :post, class: "d-flex gap-2" do |f|
              = f.text_field :discount_code,
                  class: "form-control form-control-sm",
                  placeholder: "Enter code",
                  autocomplete: "off"
              = f.submit "Apply", class: "btn btn-sm btn-outline-primary"

      - available_methods = DeliveryMethod.where(active: true).order(:name)
      - unless available_methods.empty?
        .card.shadow-sm.border-0.mb-3
          .card-body
            %p.fw-semibold.mb-2
              %i.bi.bi-truck.me-1
              Delivery Method
            - if @delivery_method
              .d-flex.align-items-center.justify-content-between
                %span.text-muted.small
                  = @delivery_method.name
                  &mdash;
                  = @delivery_method.price_cents.zero? ? "Free" : number_to_currency(@delivery_method.price)
                = button_to cart_delivery_method_path, method: :delete, class: "btn btn-sm btn-outline-danger",
                    form: { data: { turbo_confirm: "Remove delivery method?" } } do
                  %i.bi.bi-x-lg
            - else
              = form_with url: cart_delivery_method_path, method: :post, class: "d-flex gap-2" do |f|
                = f.select :delivery_method_id,
                    available_methods.map { |m| [m.price_cents.zero? ? "#{m.name} (Free)" : "#{m.name} (#{number_to_currency(m.price)})", m.id] },
                    { include_blank: "Select a method…" },
                    class: "form-select form-select-sm"
                = f.submit "Select", class: "btn btn-sm btn-primary"

      - if @delivery_method&.address_required?
        :ruby
          current_country = ISO3166::Country[@cart_address[:country]]
          initial_subdivisions = current_country&.subdivisions&.values&.map(&:name)&.compact&.sort || []
          all_countries = ISO3166::Country.all.sort_by(&:common_name).map { |c| [c.common_name, c.alpha2] }
        .card.shadow-sm.border-0
          .card-body
            %p.fw-semibold.mb-3
              %i.bi.bi-house-fill.me-1
              Delivery Address
            = form_with url: cart_address_path, method: :post, scope: :cart_address do |f|
              %div{data: { controller: "address" }}
                .mb-2
                  = f.label :street_address, "Street address", class: "form-label form-label-sm"
                  = f.text_field :street_address,
                      value: @cart_address[:street_address],
                      required: true,
                      autocomplete: "street-address",
                      placeholder: "123 Main St",
                      class: "form-control form-control-sm"
                .row.g-2.mb-2
                  .col
                    = f.label :city, "City", class: "form-label form-label-sm"
                    = f.text_field :city,
                        value: @cart_address[:city],
                        required: true,
                        autocomplete: "address-level2",
                        class: "form-control form-control-sm"
                  .col
                    = f.label :postal_code, "Postal code", class: "form-label form-label-sm"
                    = f.text_field :postal_code,
                        value: @cart_address[:postal_code],
                        required: true,
                        autocomplete: "postal-code",
                        placeholder: "A1A 1A1",
                        class: "form-control form-control-sm"
                .mb-2
                  = f.label :country, "Country", class: "form-label form-label-sm"
                  = f.select :country, all_countries,
                      { selected: @cart_address[:country] },
                      required: true,
                      class: "form-select form-select-sm",
                      data: { address_target: "country", action: "change->address#countryChanged" }
                .mb-3{hidden: initial_subdivisions.empty?, data: {address_target: "subdivisionWrapper"}}
                  = f.label :province, "Province / State", class: "form-label form-label-sm"
                  = f.select :province, initial_subdivisions,
                      { include_blank: "Select…", selected: @cart_address[:province] },
                      required: !initial_subdivisions.empty?,
                      class: "form-select form-select-sm",
                      data: { address_target: "subdivision" }
                .form-check.mb-3
                  = f.check_box :also_save_as_default, { checked: false }, "1", "0"
                  = f.label :also_save_as_default, "Save as my default address", class: "form-check-label"
                = f.submit "Save address", class: "btn btn-primary btn-sm w-100"

    .col-12.col-lg-7
      .card.shadow-sm.border-0
        .card-body.p-0
          .table-responsive
            %table.table.align-middle.mb-0
              %thead
                %tr
                  %th.ps-3 Listing
                  %th.text-end Price
                  %th
              %tbody
                - @cart_items.each do |item|
                  %tr
                    %td.ps-3
                      .d-flex.align-items-center.gap-3
                        - if item.listing.images.attached?
                          = image_tag item.listing.images.first,
                              class: "rounded-2 object-fit-cover flex-shrink-0",
                              style: "width: 52px; height: 52px"
                        - else
                          .rounded-2.bg-secondary-subtle.d-flex.align-items-center.justify-content-center.flex-shrink-0{ style: "width: 52px; height: 52px" }
                            %i.bi.bi-image.text-secondary
                        .lh-sm
                          = link_to item.listing.name, listing_path(item.listing), class: "text-decoration-none fw-semibold"
                          - if item.listing.tax_exempt?
                            %span.badge.bg-secondary.ms-1.fw-normal Tax Exempt
                          - if item.rental?
                            %br
                            %small.text-muted
                              = item.rental_start_at.to_fs(:short)
                              →
                              = item.rental_end_at.to_fs(:short)
                    %td.text-end= number_to_currency(Money.new(item.effective_price_cents))
                    %td.text-end.pe-3
                      = button_to cart_item_path(item),
                          method: :delete, class: "btn btn-sm btn-outline-danger",
                          form: { data: { turbo_confirm: "Remove from cart?" } } do
                        %i.bi.bi-trash
              %tfoot
                %tr.border-top
                  %td.ps-3.text-muted Subtotal
                  %td.text-end.text-muted= number_to_currency(@subtotal)
                  %td
                %tr
                  %td.ps-3.text-muted
                    Tax (#{(SALES_TAX_RATE * 100).to_i}%)
                  %td.text-end.text-muted= number_to_currency(@tax)
                  %td
                - if @delivery_method
                  %tr.table-info
                    %td.ps-3
                      %i.bi.bi-truck.me-1
                      = @delivery_method.name
                    %td.text-end
                      = @delivery_method.price_cents.zero? ? "Free" : number_to_currency(@delivery)
                    %td
                - if @discount_code
                  %tr.table-success
                    %td.ps-3
                      %i.bi.bi-ticket-perforated.me-1
                      = @discount_code.key
                      - if @discount_code.percentage?
                        = "(#{@discount_code.amount_cents / 100}% off)"
                    %td.text-end= number_to_currency(-@discount_savings)
                    %td
                %tr.border-top.border-2
                  %th.ps-3.fs-5 Total
                  %th.text-end.fs-5= number_to_currency(@total)
                  %th
                %tr
                  %td{colspan: 3}
                    = form_with url: orders_path, method: :post do
                      = submit_tag "Place Order", class: "btn btn-success w-100 mt-2"
