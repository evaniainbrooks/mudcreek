- set_meta_tags title: "My Cart"

%h1.fw-bold.mb-4 My Cart

- if @cart_items.empty?
  = render EmptyStateComponent.new(icon: "cart-x",
      message: "Your cart is empty.",
      link_text: "Browse Listings",
      link_url: listings_path)
- else
  .table-responsive
    %table.table.align-middle
      %thead
        %tr
          %th Listing
          %th.text-end Price
          %th
      %tbody
        - @cart_items.each do |item|
          %tr
            %td
              .d-flex.align-items-center.gap-3
                - if item.listing.images.attached?
                  = image_tag item.listing.images.first,
                      class: "rounded-2 object-fit-cover flex-shrink-0",
                      style: "width: 52px; height: 52px"
                - else
                  .rounded-2.bg-secondary-subtle.d-flex.align-items-center.justify-content-center.flex-shrink-0{ style: "width: 52px; height: 52px" }
                    %i.bi.bi-image.text-secondary
                .lh-sm
                  = link_to item.listing.name, listing_path(item.listing), class: "text-decoration-none fw-semibold"
                  - if item.listing.tax_exempt?
                    %span.badge.bg-secondary.ms-1.fw-normal Tax Exempt
                  - if item.rental?
                    %br
                    %small.text-muted
                      = item.rental_start_at.to_fs(:short)
                      →
                      = item.rental_end_at.to_fs(:short)
            %td.text-end= number_to_currency(Money.new(item.effective_price_cents))
            %td.text-end
              = button_to cart_item_path(item),
                  method: :delete, class: "btn btn-sm btn-outline-danger",
                  form: { data: { turbo_confirm: "Remove from cart?" } } do
                %i.bi.bi-trash
      %tfoot
        %tr.border-top
          %td.text-muted Subtotal
          %td.text-end.text-muted= number_to_currency(@subtotal)
          %td
        %tr
          %td.text-muted
            Tax (#{(SALES_TAX_RATE * 100).to_i}%)
          %td.text-end.text-muted= number_to_currency(@tax)
          %td
        - if @delivery_method
          %tr.table-info
            %td
              %i.bi.bi-truck.me-1
              = @delivery_method.name
            %td.text-end
              - if @delivery_method.price_cents.zero?
                Free
              - else
                = number_to_currency(@delivery)
            %td.text-end
              = button_to cart_delivery_method_path, method: :delete, class: "btn btn-sm btn-outline-danger",
                  form: { data: { turbo_confirm: "Remove delivery method?" } } do
                %i.bi.bi-trash
        - if @discount_code
          %tr.table-success
            %td
              %i.bi.bi-ticket-perforated.me-1
              = @discount_code.key
              - if @discount_code.percentage?
                = "(#{@discount_code.amount_cents / 100}% off)"
            %td.text-end= number_to_currency(-@discount_savings)
            %td.text-end
              = button_to cart_discount_path, method: :delete, class: "btn btn-sm btn-outline-danger",
                  form: { data: { turbo_confirm: "Remove discount code?" } } do
                %i.bi.bi-trash
        %tr.border-top.border-2
          %th.fs-5 Total
          %th.text-end.fs-5= number_to_currency(@total)
          %th

  - available_methods = DeliveryMethod.where(active: true).order(:name)
  - unless available_methods.empty?
    .d-flex.justify-content-end.mt-4
      .card.shadow-sm.border-0
        .card-body
          %p.fw-semibold.mb-2
            %i.bi.bi-truck.me-1
            Delivery Method
          - if @delivery_method
            %p.text-muted.mb-0.small
              Selected:
              %strong= @delivery_method.name
          - else
            = form_with url: cart_delivery_method_path, method: :post, class: "d-flex gap-2" do |f|
              = f.select :delivery_method_id,
                  available_methods.map { |m| [m.price_cents.zero? ? "#{m.name} (Free)" : "#{m.name} (#{number_to_currency(m.price)})", m.id] },
                  { include_blank: "Select a method…" },
                  class: "form-select", style: "max-width: 280px"
              = f.submit "Select", class: "btn btn-primary"

  - unless @discount_code
    .d-flex.justify-content-end.mt-4
      .card.shadow-sm.border-0
        .card-body
          %p.fw-semibold.mb-2
            %i.bi.bi-ticket-perforated.me-1
            Have a discount code?
          = form_with url: cart_discount_path, method: :post, class: "d-flex gap-2" do |f|
            = f.text_field :discount_code,
                class: "form-control",
                placeholder: "Enter code",
                autocomplete: "off",
                style: "max-width: 240px"
            = f.submit "Apply", class: "btn btn-primary"
